<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VidaLink</title>

  <!-- RUTAS CORRECTAS DESDE /docs -->
  <link rel="icon" type="image/png" href="../RECURSOS/vidalink.png">
  <link rel="stylesheet" href="../CSS/styles.css">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
<nav class="navbar bg-body-tertiary navbar-compact">
  <div class="container-fluid">
    <div class="d-flex align-items-center gap-2">
      <img src="../RECURSOS/logo.png" alt="Logo" width="200" height="55">
    </div>

    <div class="d-flex align-items-center gap-3 ms-auto">
      <button id="btn-perfil" class="btn btn-outline-danger d-flex align-items-center gap-1">
        <img src="../RECURSOS/usuario.png" width="26" height="26">
        Mi Perfil
      </button>

      <button class="estado-conectado d-flex align-items-center gap-1">
        <img src="../RECURSOS/conectado.png" width="14" height="14">
        Conectado
      </button>

      <button id="btn-voluntarios" class="btn btn-outline-primary btn-lg align-items-center gap-2">
        Panel de Voluntarios
      </button>

      <button id="btn-salir" class="btn btn-outline-danger btn-lg d-flex align-items-center gap-2">
        <img src="../RECURSOS/Exit.png" width="24" height="24">
        Salir
      </button>
    </div>
  </div>
</nav>

<main>
  <!-- (contenido visual intacto, no lo toqué) -->
</main>

<!-- SCRIPT PRINCIPAL -->
<script type="module">
  import { observarEstadoAuth, cerrarSesion } from '../SCRIPT/auth.js';
  import { inicializarSOS } from '../SCRIPT/sos.js';
  import { db } from '../SCRIPT/firebase-init.js';
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const btnPerfil = document.getElementById('btn-perfil');
  const btnSalir = document.getElementById('btn-salir');
  const btnVoluntarios = document.getElementById('btn-voluntarios');
  const conectadoBtn = document.querySelector('.estado-conectado');
  const mainContent = document.querySelector('main');

  // ESTADO INICIAL SEGURO
  btnVoluntarios.style.display = 'none';
  btnSalir.style.display = 'none';
  conectadoBtn.style.display = 'none';

  btnPerfil.onclick = () => location.href = 'perfil.html';
  btnVoluntarios.onclick = () => location.href = 'voluntarios.html';

  btnSalir.onclick = async () => {
    await cerrarSesion();
    location.reload();
  };

  observarEstadoAuth(async (user) => {
    if (!user) {
      mainContent.innerHTML = `
        <div class="d-flex align-items-center justify-content-center min-vh-100">
          <div class="card p-5 text-center">
            <h2>Bienvenido a VidaLink</h2>
            <p>Inicia sesión para continuar</p>
            <button onclick="location.href='login.html'" class="btn btn-danger m-2">Iniciar sesión</button>
            <button onclick="location.href='registro.html'" class="btn btn-outline-danger m-2">Registrarme</button>
          </div>
        </div>`;
      return;
    }

    // USUARIO LOGUEADO
    btnSalir.style.display = 'flex';
    conectadoBtn.style.display = 'flex';

    try {
      const snap = await getDoc(doc(db, "usuarios", user.uid));
      if (snap.exists() && snap.data().esVoluntario === true) {
        btnVoluntarios.style.display = 'flex';
      }
    } catch (e) {
      console.error("Error verificando rol", e);
    }

    inicializarSOS();
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<footer class="site-footer">
  <p>No reemplazamos ambulancias, las complementamos con ayuda ciudadana.</p>
  <p>&copy; 2025 VidaLink</p>
</footer>
</body>
</html>
